{% extends "base.html" %}

{% block content %}
<!-- ENCABEZADO -->
<div class="flex justify-between items-center mb-6">
    <div>
        <h1 class="text-3xl font-bold text-base-content">Dashboard Operativo</h1>
        <p class="text-gray-500">Resumen del {{ dia_actual }} {{ fecha_hoy }}</p>
    </div>
    <div class="flex gap-2">
        <a href="{{ url_for('finanzas.cobrar', socio_id=1) }}" class="btn btn-primary btn-sm">+ Cobro RÃ¡pido</a>
        <button class="btn btn-ghost btn-sm">ðŸ”„ Actualizar</button>
    </div>
</div>

<!-- 1. KPIs (STATS DAISYUI) -->
<div class="stats shadow w-full mb-8 bg-base-100">
  
  <div class="stat">
    <div class="stat-figure text-success">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
    </div>
    <div class="stat-title">Ingresos Hoy</div>
    <div class="stat-value text-success">${{ "{:,.2f}".format(ingresos_hoy) }}</div>
    <div class="stat-desc">Corte de caja actual</div>
  </div>
  
  <div class="stat">
    <div class="stat-figure text-secondary">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
    </div>
    <div class="stat-title">Asistencia Hoy</div>
    <div class="stat-value text-secondary">{{ asistencias_hoy }}</div>
    <div class="stat-desc">Alumnos en el agua</div>
  </div>
  
  <div class="stat">
    <div class="stat-figure text-primary">
      <div class="avatar online">
        <div class="w-16 rounded-full">
            <span class="text-3xl flex items-center justify-center h-full bg-primary text-white font-bold">
                {{ total_alumnos }}
            </span>
        </div>
      </div>
    </div>
    <div class="stat-title">Total Activos</div>
    <div class="stat-value">{{ total_alumnos }}</div>
    <div class="stat-desc">MatrÃ­cula vigente</div>
  </div>
  
</div>

<!-- 2. GRID PRINCIPAL -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    
    <!-- COLUMNA IZQ: GRÃFICA (2/3 del ancho) -->
    <div class="lg:col-span-2 card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">Tendencia de Ingresos (7 DÃ­as)</h2>
            <div class="h-64 w-full">
                <canvas id="incomeChart"></canvas>
            </div>
        </div>
    </div>

    <!-- COLUMNA DER: CLASES DE HOY (1/3 del ancho) -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title text-sm">Agenda de Hoy ({{ dia_actual }})</h2>
            <div class="overflow-y-auto h-64">
                <ul class="menu bg-base-100 w-full p-0">
                    {% for clase in clases_hoy %}
                    {% set porcentaje = (clase.cupos_disponibles() / clase.capacidad_maxima) * 100 %}
                    <li class="border-b border-base-200">
                        <a href="{{ url_for('horarios.detalle_clase', id=clase.id) }}" class="flex justify-between">
                            <div>
                                <span class="font-bold block">{{ clase.hora_inicio.strftime('%H:%M') }}</span>
                                <span class="text-xs badge badge-ghost">{{ clase.nivel }}</span>
                            </div>
                            <div class="text-right">
                                <span class="text-xs">Cupo</span>
                                <progress class="progress progress-primary w-16" value="{{ clase.capacidad_maxima - clase.cupos_disponibles() }}" max="{{ clase.capacidad_maxima }}"></progress>
                            </div>
                        </a>
                    </li>
                    {% else %}
                    <li class="text-center p-4 text-gray-400">No hay mÃ¡s clases hoy</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- 3. TABLA DE ÃšLTIMOS MOVIMIENTOS -->
<div class="card bg-base-100 shadow-xl">
    <div class="card-body">
        <div class="flex justify-between">
            <h2 class="card-title">Ãšltimos Pagos Registrados</h2>
            <a href="#" class="btn btn-xs btn-outline">Ver Todo</a>
        </div>
        
        <div class="overflow-x-auto">
            <table class="table table-zebra w-full">
                <thead>
                    <tr>
                        <th>Hora</th>
                        <th>Socio</th>
                        <th>Concepto</th>
                        <th>MÃ©todo</th>
                        <th class="text-right">Monto</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pago in ultimos_pagos %}
                    <tr>
                        <td class="text-xs text-gray-500">{{ pago.fecha_pago.strftime('%H:%M') }}</td>
                        <td class="font-bold">{{ pago.socio.nombre_completo }}</td>
                        <td>
                            <div class="badge badge-ghost badge-sm">{{ pago.concepto_tipo }}</div>
                            <span class="text-xs ml-1">{{ pago.detalle_concepto }}</span>
                        </td>
                        <td>{{ pago.metodo_pago }}</td>
                        <td class="text-right font-mono text-success font-bold">${{ "{:,.2f}".format(pago.total_cobrado) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- SCRIPT PARA CHART.JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('incomeChart');

  new Chart(ctx, {
    type: 'line',
    data: {
      labels: {{ chart_labels | safe }},
      datasets: [{
        label: 'Ingresos ($)',
        data: {{ chart_values | safe }},
        borderColor: '#3b82f6', // Azul Tailwind
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        tension: 0.3,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: true }
      },
      plugins: {
        legend: { display: false }
      }
    }
  });
</script>
{% endblock %}