{% extends "base.html" %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- COLUMNA IZQUIERDA: INFORMACI√ìN PERSONAL -->
    <div class="lg:col-span-1">
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body items-center text-center">
                <!-- Avatar -->
                <div class="avatar placeholder mb-4">
                    <div class="bg-primary text-neutral-content rounded-full w-24">
                        <span class="text-3xl">{{ socio.nombre_completo[:2].upper() }}</span>
                    </div>
                </div>
                
                <h2 class="card-title">{{ socio.nombre_completo }}</h2>
                <p class="text-neutral-500">{{ socio.folio }}</p>
                
                <!-- Badge de Estatus -->
                <div class="badge badge-lg {{ color_estatus }}">{{ estatus }}</div>
                
                <div class="divider"></div>
                
                <div class="text-left space-y-2 w-full">
                    <p><strong>Nivel:</strong> <span class="badge badge-info">{{ socio.nivel }}</span></p>
                    <p><strong>Plan:</strong> {{ socio.membresia.nombre }}</p>
                    <p><strong>Tel√©fono:</strong> {{ socio.telefono or 'No registrado' }}</p>
                    <p><strong>Email:</strong> {{ socio.email or 'No registrado' }}</p>
                    <p><strong>Registro:</strong> {{ socio.fecha_registro.strftime('%d/%m/%Y') }}</p>
                </div>

                <div class="card-actions justify-center w-full mt-4 space-y-2">
                    <a href="{{ url_for('finanzas.cobrar', socio_id=socio.id) }}" class="btn btn-success btn-block">üí≤ Registrar Pago</a>
                    <a href="{{ url_for('academico.inscribir', socio_id=socio.id) }}" class="btn btn-primary btn-block">üìÖ Gestionar Clases</a>
                    <a href="{{ url_for('socios.editar', id=socio.id) }}" class="btn btn-outline btn-secondary btn-block">‚úèÔ∏è Editar Datos</a>
                </div>
            </div>
        </div>
    </div>

    <!-- COLUMNA DERECHA: HISTORIALES -->
    <div class="lg:col-span-2">
        <div class="card bg-base-100 shadow-xl h-full">
            <div class="card-body">
                <div role="tablist" class="tabs tabs-lifted">
                    <!-- TAB 1: PAGOS -->
                    <input type="radio" name="my_tabs" role="tab" class="tab" aria-label="üí∞ Historial Pagos" checked />
                    <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6">
                        {% if pagos %}
                        <div class="overflow-x-auto">
                            <table class="table table-zebra w-full">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Concepto</th>
                                        <th>Monto</th>
                                        <th>Acci√≥n</th> <!-- Columna Nueva -->
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for pago in pagos %}
                                    <tr>
                                        <td>{{ pago.fecha_pago.strftime('%d/%m/%Y') }}</td>
                                        <td>
                                            <div class="font-bold">{{ pago.concepto_tipo }}</div>
                                            <div class="text-xs opacity-50">{{ pago.detalle_concepto }}</div>
                                        </td>
                                        <td class="text-success font-bold">${{ pago.total_cobrado }}</td>
                                        <td>
                                            <!-- BOT√ìN QUE ABRE EL MODAL -->
                                            <button onclick="abrirRecibo({{ pago.id }})" 
                                                    class="btn btn-sm btn-ghost border-gray-200">
                                                üñ®Ô∏è Recibo
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-center text-neutral-500 mt-4">No hay pagos registrados.</p>
                        {% endif %}
                    </div>

                    <!-- TAB 2: ASISTENCIA -->
                    <input type="radio" name="my_tabs" role="tab" class="tab" aria-label="‚úÖ Asistencias" />
                    <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6">
                        {% if asistencias %}
                        <div class="overflow-x-auto">
                            <table class="table table-zebra w-full">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>D√≠a</th>
                                        <th>Clase</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for a in asistencias %}
                                    <tr>
                                        <td>{{ a.fecha.strftime('%d/%m/%Y') }}</td>
                                        <td>{{ a.horario.dia_semana }}</td>
                                        <td>{{ a.horario.hora_inicio.strftime('%H:%M') }}</td>
                                        <td>
                                            {% if a.estado == 'Presente' %}
                                                <div class="badge badge-success">Presente</div>
                                            {% else %}
                                                <div class="badge badge-error">{{ a.estado }}</div>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-center text-neutral-500 mt-4">No hay registros de asistencia recientes.</p>
                        {% endif %}
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL DE DAISYUI -->
<dialog id="modal_recibo" class="modal">
    <div class="modal-box w-11/12 max-w-3xl h-[90vh] p-0 relative bg-gray-200">
      
      <!-- BARRA SUPERIOR DEL MODAL -->
      <div class="bg-base-100 p-2 flex justify-between items-center shadow-md z-10 sticky top-0">
          <h3 class="font-bold text-lg px-4">Vista Previa</h3>
          <div class="flex gap-2">
              <!-- Bot√≥n IMPRIMIR (Llama a la funci√≥n del iframe) -->
              <button onclick="imprimirIframe()" class="btn btn-primary btn-sm">
                  üñ®Ô∏è Imprimir
              </button>
              <!-- Bot√≥n CERRAR -->
              <form method="dialog">
                  <button class="btn btn-circle btn-ghost btn-sm">‚úï</button>
              </form>
          </div>
      </div>
  
      <!-- IFRAME DONDE SE CARGA EL RECIBO -->
      <iframe id="iframe_recibo" src="" class="w-full h-full border-0 bg-white"></iframe>
  
    </div>
    
    <!-- Cierra al hacer clic fuera -->
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>
  
  <!-- SCRIPT DE CONTROL -->
  <script>
      function abrirRecibo(pagoId) {
          // 1. Construir la URL del recibo
          const url = `/finanzas/recibo/${pagoId}`;
          
          // 2. Cargarla en el iframe
          const iframe = document.getElementById('iframe_recibo');
          iframe.src = url;
          
          // 3. Mostrar el modal
          document.getElementById('modal_recibo').showModal();
      }
  
      function imprimirIframe() {
          const iframe = document.getElementById('iframe_recibo');
          // Enfocar y mandar a imprimir el contenido del iframe, no la p√°gina completa
          iframe.contentWindow.focus();
          iframe.contentWindow.print();
      }
  </script>
{% endblock %}
